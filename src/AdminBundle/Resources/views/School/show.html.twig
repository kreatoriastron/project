{% extends "base.html.twig" %}
 {% block body %}
     {{ parent() }}
         <!-- BEGIN CONTENT -->
         <div class="page-content-wrapper">
             <div class="page-content">
                 <!-- BEGIN PAGE HEAD -->
                 <div class="page-head">
                     <!-- BEGIN PAGE TITLE -->
                     <div class="page-title">
                         <h1>Administracja <small>Szkoły</small></h1>
                     </div>
                     <!-- END PAGE TITLE -->
                 </div>
                 <!-- END PAGE HEAD -->
                 <!-- BEGIN PAGE BREADCRUMB -->
                 <ul class="page-breadcrumb breadcrumb">
                     <li>
                         <a href="javascript:;">Administracja</a><i class="fa fa-circle"></i>
                     </li>
                     <li class="active">
                         Szkoły
                     </li>
                 </ul>
                 <!-- END PAGE BREADCRUMB -->
                 <!-- BEGIN PAGE CONTENT INNER -->
                 <div id="mainBox">
                     <div class="row">
                         <div class="col-md-12">
                             <div class="portlet light">
                                 <div class="portlet-title">
                                     <div class="caption">
                                         <i class="fa fa-gift font-green-sharp"></i>
                                         <span class="caption-subject font-green-sharp bold uppercase">Lista Szkół</span>
                                     </div>
                                 </div>
                                 <div class="portlet-body">
                                     <div class="table-container" style="">
                                         <div id="datatable_ajax_wrapper" class="dataTables_wrapper dataTables_extended_wrapper no-footer">
                                            <div class="margin-bottom-5" style="display: inline; float: left; padding-right: 15px;">
                                                <button class="btn btn-sm yellow filter-submit margin-bottom" id="search"><i class="fa fa-search"></i> Szukaj</button>
                                            </div>
                                            <div class="margin-bottom-5">
                                                <button class="btn btn-sm green filter-submit margin-bottom" data-target="#selectDr" data-toggle="modal" id="addToDR"><i class="fa fa-user"></i> Przypisz do DR</button>
                                            </div>
                                            <div class="table-scrollable"><table class="table table-striped table-bordered table-hover dataTable no-footer" id="datatable_ajax" aria-describedby="datatable_ajax_info" role="grid">
                                                <thead>
                                                     <tr role="row" class="heading">
                                                         <th width="2%" class="sorting_disabled" rowspan="1" colspan="1">
                                                             <div class="form-check">
                                                                 <input class="form-check-input group-checkable" type="checkbox">
                                                             </div>
                                                         </th>
                                                         <th width="10%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Województwo
                                                         </th>
                                                         <th width="2%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Powiat
                                                         </th>
                                                         <th width="2%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Gmina
                                                         </th>
                                                         <th width="10%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Miasto
                                                         </th>
                                                         <th width="10%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Nazwa
                                                         </th>
                                                         <th width="10%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Nazwa własna
                                                         </th>
                                                         <th width="10%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Adres
                                                         </th>
                                                         <th width="2%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Kod pocztowy
                                                         </th>
                                                         <th width="5%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Poczta
                                                         </th>
                                                         <th width="10%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Telefon
                                                         </th>
                                                         <th width="2%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             WWW
                                                         </th>
                                                         <th width="2%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Publiczność
                                                         </th>
                                                         <th width="2%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Liczba uczniów
                                                         </th>
                                                         <th width="2%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Liczba klas
                                                         </th>
                                                         <th width="10%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Dr
                                                         </th>
                                                         <th width="10%" class="sorting" tabindex="0" aria-controls="datatable_ajax" rowspan="1" colspan="1">
                                                             Akcje
                                                         </th>
                                                     </tr>
                                                     <tr role="row" class="filter"><td rowspan="1" colspan="1">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <select name="wojewodztwo" class="form-control form-filter input-sm">
                                                                 <option value=""></option>
                                                                 {% for wojewodztwo in wojewodztwa %}
                                                                     <option value="{{ wojewodztwo.id }}">{{ wojewodztwo.name }}</option>
                                                                 {% endfor %}
                                                             </select>
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="powiat">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="gmina">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="city">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="name">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="nameOwn">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="address">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="zipcode">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="post">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="phone">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="www">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="publicznosc">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <div class="margin-bottom-5">
                                                                 <input type="text" class="form-control form-filter input-sm margin-bottom-5 clearfix" name="studentCount_from" placeholder="Od">
                                                             </div>
                                                             <input type="text" class="form-control form-filter input-sm" name="studentCount_to" placeholder="Do">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <div class="margin-bottom-5">
                                                                 <input type="text" class="form-control form-filter input-sm margin-bottom-5 clearfix" name="classCount_from" placeholder="Od">
                                                             </div>
                                                             <input type="text" class="form-control form-filter input-sm" name="classCount_to" placeholder="Do">
                                                         </td>
                                                         <td rowspan="1" colspan="1">
                                                             <input type="text" class="form-control form-filter input-sm" name="dr">
                                                         </td>
                                                     </tr>
                                                </thead>
                                                     <tbody>
                                                         {% for school in schools %}
                                                         <tr>
                                                             <td><input type="checkbox" name="id[]" value="{{ school.id }}"></td>
                                                             <td>{{ school.wojewodztwo }}</td>
                                                             <td>{{ school.powiat }}</td>
                                                             <td>{{ school.gmina }}</td>
                                                             <td>{{ school.city }}</td>
                                                             <td>{{ school.name }}</td>
                                                             <td>{{ school.name_own }}</td>
                                                             <td>{{ school.address }}</td>
                                                             <td>{{ school.zipcode }}</td>
                                                             <td>{{ school.post }}</td>
                                                             <td>{{ school.phone }}</td>
                                                             <td>{{ school.www }}</td>
                                                             <td>{{ school.publicznosc }}</td>
                                                             <td>{{ school.student_count }}</td>
                                                             <td>{{ school.class_count }}</td>
                                                             <td>{{ school.dr }}</td>
                                                             <td>
                                                                 <button class="btn btn-sm blue filter-submit margin-bottom edit" data-url="{{ path('edit_school', {'schoolId': school.id}) }}">Edytuj</button>
                                                             </td>
                                                         </tr>
                                                         {% endfor %}
                                                     </tbody>
                                                 </table></div>

                                     </div>
                                 </div>
                             </div>
                             <!-- End: life time stats -->
                         </div>
                     </div>
                 </div>
             </div>
                 <div id="modalContainer">
                     <div id="selectDr" class="modal fade" tabindex="-1" aria-hidden="true">
                         <div class="modal-header">
                             <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                             <h4 class="modal-title">Przypisywanie szkół do DR</h4>
                         </div>
                         <div class="modal-body">
                             <label>Wybierz DR</label>
                             <p>
                                 <select id="select_dr" name="dr" placeholder="DR">
                                     <option></option>
                                     {% for DR in drList %}
                                         <option value="{{ DR.id }}">{{ DR.surname }} {{ DR.name }}</option>
                                     {%  endfor %}
                                 </select>
                             </p>
                         </div>
                         <div class="modal-footer">
                             <button type="button" data-dismiss="modal" class="btn btn-default">Anuluj</button>
                             <button type="button" data-dismiss="modal" id="selectDrSubmit" class="btn btn-primary">Przypisz</button>
                         </div>
                     </div>
                 </div>
         </div>
 {% endblock %}
 {%  block stylesheets %}
     {{  parent() }}
     <link rel="stylesheet" type="text/css" href="{{ asset('assets/global/plugins/bootstrap-modal/css/bootstrap-modal-bs3patch.css') }}">
     <link rel="stylesheet" type="text/css" href="{{ asset('assets/global/plugins/bootstrap-modal/css/bootstrap-modal.css') }}">
     <link rel="stylesheet" type="text/css" href="{{ asset('assets/global/plugins/selectize/selectize.css') }}">
 {% endblock %}
 {% block javascripts %}
     {{  parent() }}
     <script type="text/javascript" src="{{ asset('assets/global/plugins/bootstrap-modal/js/bootstrap-modalmanager.js') }}"></script>
     <script type="text/javascript" src="{{ asset('assets/global/plugins/bootstrap-modal/js/bootstrap-modal.js') }}"></script>
     <script type="text/javascript" src="{{ asset('assets/global/plugins/select2/select2.min.js') }}"></script>
     <script type="text/javascript" src="{{ asset('assets/global/plugins/selectize/selectize.js') }}"></script>
     <script>
         $(document).ready(function(){
             $('#search').click(function() {
                 $.ajax({
                     type: "POST",
                     url: '{{ path('filter_school') }}',
                     data: $( ".form-filter" ).serialize(),
                     success: function ($data) {
                         var response= JSON.parse($data);
                         $('#datatable_ajax > tbody tr').remove();
                         $.each(response, function(i, row) {
                             $('<tr>').append(
                                     $('<td>').html('<input type="checkbox" name="id[]" value="' + row.id + '">'),
                                     $('<td>').text(row.wojewodztwo),
                                     $('<td>').text(row.powiat),
                                     $('<td>').text(row.gmina),
                                     $('<td>').text(row.city),
                                     $('<td>').text(row.name),
                                     $('<td>').text(row.name_own),
                                     $('<td>').text(row.address),
                                     $('<td>').text(row.zipcode),
                                     $('<td>').text(row.post),
                                     $('<td>').text(row.phone),
                                     $('<td>').text(row.www),
                                     $('<td>').text(row.publicznosc),
                                     $('<td>').text(row.student_count),
                                     $('<td>').text(row.class_count),
                                     $('<td>').text(row.dr),
                                     $('<td>').html('<button class="btn btn-sm blue filter-submit margin-bottom edit" data-url="edit/' + row.id + '">Edytuj</button>')
                             ).appendTo('#datatable_ajax > tbody');

                         });

                     }
                 });
             });
             $('#select_dr').selectize();

             $("#mainBox").on("click",".edit", function(){
                 var url = $(this).data('url');
                 window.location = url;
             });

             $("#mainBox").on("click",".group-checkable", function(){
                 if($(this).prop('checked')) {
                     $('input[type="checkbox"]').prop('checked', true).change();
                 } else {
                     $('input[type="checkbox"]').prop('checked', false).change();
                 }
             });

             $('#selectDrSubmit').click(function(){
                 if(!$('#select_dr').val()) { return 0; }

                 var fields = $('#mainBox tbody input:checked, #select_dr').serializeArray();
                 $.ajax({
                     type: "POST",
                     url: '{{ path('assign_dr_to_school') }}',
                     data: fields,
                     success: function ($response) {
                         toastr.options = {
                             "closeButton": true,
                             "debug": false,
                             "positionClass": "toast-top-center",
                             "onclick": null,
                             "showDuration": "1000",
                             "hideDuration": "1000",
                             "timeOut": "5000",
                             "extendedTimeOut": "1000",
                             "showEasing": "swing",
                             "hideEasing": "linear",
                             "showMethod": "fadeIn",
                             "hideMethod": "fadeOut"
                         }
                         if($response == 'correct') {
                             toastr['success']('Wybrane placówki zostały poprawnie przypisane do DR', 'Przypisano szkoły');
                             $('#search').click();
                             $('.group-checkable').prop('checked', false).change();
                         } else {
                             toastr['error']('Wybrane placówki nie zostały przypisane do DR', 'Wystaił błąd');
                         }
                     }
                 });
             });
         })
     </script>
 {% endblock %}

